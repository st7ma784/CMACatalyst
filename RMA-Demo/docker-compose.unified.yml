version: '3.8'

# Unified Edge Infrastructure
# Coordinator + Tunnel + Workers all in one stack with proper networking

services:
  # Core coordinator service
  coordinator:
    image: ghcr.io/st7ma784/cmacatalyst/coordinator:latest
    container_name: edge-coordinator
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8468:8468/udp"  # DHT port
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - DHT_PORT=8468
      - DHT_ENABLED=true
      - NODE_ENV=production
      - WORKER_STATE_FILE=/data/coordinator_workers.json
    volumes:
      - coordinator-data:/data  # Persist worker registry
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - edge-network

  # Cloudflare tunnel for coordinator access
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: edge-tunnel
    restart: always  # Always restart on failure
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared-config.yml:/etc/cloudflared/config.yml:ro
      - ./tunnel-credentials.json:/etc/cloudflared/credentials.json:ro
    # No depends_on - coordinator should run independently
    networks:
      - edge-network

  # Edge registrar (registers coordinator with edge router)
  registrar:
    image: ghcr.io/st7ma784/cmacatalyst/universal-worker:latest
    container_name: edge-registrar
    restart: always  # Keep trying to register
    environment:
      - WORKER_TYPE=edge
      - COORDINATOR_URL=https://api.rmatool.org.uk
      - TUNNEL_URL=https://edge-1.rmatool.org.uk
    # No depends_on - should keep trying independently
    networks:
      - edge-network

  # GPU Worker (optional - comment out if no GPU)
  gpu-worker:
    image: ghcr.io/st7ma784/cmacatalyst/universal-worker:latest
    container_name: gpu-worker-1
    restart: unless-stopped
    environment:
      # Connect to LOCAL coordinator, not edge router
      - COORDINATOR_URL=http://coordinator:8080
      - USE_TUNNEL=true
      - WORKER_TYPE=gpu  # Force GPU worker type
      - LLM_MODEL=microsoft/Phi-3-mini-4k-instruct
      # GPU settings
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - gpu-models:/models
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      coordinator:
        condition: service_healthy
    networks:
      - edge-network

volumes:
  coordinator-data:
    driver: local
  gpu-models:
    driver: local

networks:
  edge-network:
    driver: bridge
