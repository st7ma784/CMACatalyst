version: '3.8'

services:
  vllm:
    image: vllm/vllm-openai:latest
    container_name: rma-vllm
    ports:
      - "8000:8000"
    volumes:
      # Shared model cache across services
      - model_cache:/models
      - vllm_data:/root/.cache
    environment:
      - VLLM_API_KEY=local
      - VLLM_HOST=0.0.0.0
      - VLLM_PORT=8000
      - VLLM_SERVED_MODEL_NAME=mistral
      # Model cache locations
      - HF_HOME=/models/huggingface
      - TRANSFORMERS_CACHE=/models/huggingface
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 12G  # Increased for model loading
        reservations:
          memory: 8G  # Minimum 8GB for Mistral-7B
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: --model mistralai/Mistral-7B-Instruct-v0.2 --gpu-memory-utilization 0.9 --tensor-parallel-size 1 --download-dir /models/vllm

  embedding-service:
    build:
      context: ./services/embedding-service
      dockerfile: Dockerfile
    container_name: rma-embedding-service
    ports:
      - "8006:8006"
    volumes:
      # Shared model cache
      - model_cache:/models
    environment:
      - PORT=8006
      - DEVICE=cuda
      # Model cache locations
      - HF_HOME=/models/huggingface
      - TRANSFORMERS_CACHE=/models/huggingface
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 2G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  markitdown:
    build:
      context: ./services/markitdown
      dockerfile: Dockerfile
    container_name: rma-markitdown
    ports:
      - "8008:8000"
    environment:
      - PORT=8000
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  document-extraction-service:
    build:
      context: ./services/document-extraction-service
      dockerfile: Dockerfile
    container_name: rma-document-extraction
    ports:
      - "8007:8007"
    environment:
      - PORT=8007
      - BACKEND_SERVICE=markitdown
      - BACKEND_URL=http://markitdown:8008
      - FALLBACK_SERVICE=olmocr2
      - FALLBACK_URL=http://olmocr2:8009
    restart: unless-stopped
    depends_on:
      - markitdown

  chromadb:
    image: chromadb/chroma:0.4.24
    container_name: rma-chromadb
    ports:
      - "8005:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    restart: unless-stopped
    depends_on:
      - embedding-service
      - document-extraction-service

  notes-service:
    build:
      context: ./services/notes-service
      dockerfile: Dockerfile
    container_name: rma-notes-service
    ports:
      - "8100:8100"
    environment:
      - OLLAMA_URL=http://vllm:8000
    depends_on:
      - vllm
    restart: unless-stopped

  doc-processor:
    build:
      context: ./services/doc-processor
      dockerfile: Dockerfile
    container_name: rma-doc-processor
    ports:
      - "8101:8101"
    environment:
      - LLAMA_PARSE_API_KEY=${LLAMA_PARSE_API_KEY:-}
      - OLLAMA_URL=http://vllm:8000
      - EXTRACTION_SERVICE_URL=http://document-extraction-service:8007
    depends_on:
      - vllm
      - document-extraction-service
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  rag-service:
    build:
      context: ./services/rag-service
      dockerfile: Dockerfile
    container_name: rma-rag-service
    ports:
      - "8102:8102"
    volumes:
      - ./manuals:/manuals
    environment:
      - OLLAMA_URL=http://vllm:8000
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000
      - EMBEDDING_SERVICE_URL=http://embedding-service:8006
      - MANUALS_PATH=/manuals
    depends_on:
      - vllm
      - chromadb
      - embedding-service
    restart: unless-stopped

  client-rag-service:
    build:
      context: ./services/client-rag-service
      dockerfile: Dockerfile
    container_name: rma-client-rag-service
    ports:
      - "8104:8104"
    environment:
      - OLLAMA_URL=http://vllm:8000
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000
      - EMBEDDING_SERVICE_URL=http://embedding-service:8006
    depends_on:
      - vllm
      - chromadb
      - embedding-service
    restart: unless-stopped

  upload-service:
    build:
      context: ./services/upload-service
      dockerfile: Dockerfile
    container_name: rma-upload-service
    ports:
      - "8103:8103"
    volumes:
      - upload_data:/data/uploads
    environment:
      - JWT_SECRET=${JWT_SECRET:-change-this-in-production}
      - UPLOAD_DIR=/data/uploads
      - DOC_PROCESSOR_URL=http://doc-processor:8101
      - CLIENT_RAG_URL=http://client-rag-service:8104
      - APP_BASE_URL=${APP_BASE_URL:-http://localhost:3000}
    depends_on:
      - doc-processor
      - client-rag-service
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rma-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_NOTES_SERVICE_URL=http://localhost:8100
      - NEXT_PUBLIC_DOC_PROCESSOR_URL=http://localhost:8101
      - NEXT_PUBLIC_RAG_SERVICE_URL=http://localhost:8102
      - NEXT_PUBLIC_UPLOAD_SERVICE_URL=http://localhost:8103
    depends_on:
      - notes-service
      - doc-processor
      - rag-service
      - upload-service
    restart: unless-stopped

  mcp-server:
    build:
      context: ./services/mcp-server
      dockerfile: Dockerfile
    container_name: rma-mcp-server
    ports:
      - "8105:8105"
    environment:
      - RAG_SERVICE_URL=http://rag-service:8102
      - CLIENT_RAG_URL=http://client-rag-service:8104
      - MCP_API_KEY=${MCP_API_KEY:-dev-key-change-in-production}
      - PORT=8105
    depends_on:
      - rag-service
      - client-rag-service
    restart: unless-stopped

  n8n:
    image: n8nio/n8n:latest
    container_name: rma-n8n
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./services/n8n/workflows:/workflows:ro
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-changeme123}
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Europe/London
    depends_on:
      - mcp-server
    restart: unless-stopped

volumes:
  # Shared model cache across all GPU services
  # This volume persists downloaded models to avoid re-downloading
  # To use host directory instead: -v /host/path:/models
  model_cache:
    driver: local
  vllm_data:
  chroma_data:  # Shared ChromaDB storage for all collections
  upload_data:
  n8n_data:

networks:
  default:
    name: rma-network
