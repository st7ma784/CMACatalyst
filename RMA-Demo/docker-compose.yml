version: '3.8'

services:
  ollama:
    image: ollama/ollama:latest
    container_name: rma-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  chromadb:
    image: chromadb/chroma:0.4.24
    container_name: rma-chromadb
    ports:
      - "8005:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    restart: unless-stopped

  notes-service:
    build:
      context: ./services/notes-service
      dockerfile: Dockerfile
    container_name: rma-notes-service
    ports:
      - "8100:8100"
    environment:
      - OLLAMA_URL=http://ollama:11434
    depends_on:
      - ollama
    restart: unless-stopped

  doc-processor:
    build:
      context: ./services/doc-processor
      dockerfile: Dockerfile
    container_name: rma-doc-processor
    ports:
      - "8101:8101"
    environment:
      - LLAMA_PARSE_API_KEY=${LLAMA_PARSE_API_KEY:-}
      - OLLAMA_URL=http://ollama:11434
    depends_on:
      - ollama
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  rag-service:
    build:
      context: ./services/rag-service
      dockerfile: Dockerfile
    container_name: rma-rag-service
    ports:
      - "0.0.0.0:8102:8102"
    volumes:
      - ./manuals:/manuals
    environment:
      - OLLAMA_URL=http://ollama:11434
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000
      - MANUALS_PATH=/manuals
    depends_on:
      - ollama
      - chromadb
    restart: unless-stopped

  client-rag-service:
    build:
      context: ./services/client-rag-service
      dockerfile: Dockerfile
    container_name: rma-client-rag-service
    ports:
      - "0.0.0.0:8104:8104"
    environment:
      - OLLAMA_URL=http://ollama:11434
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000
      - RAG_SERVICE_URL=http://rag-service:8102
    depends_on:
      - ollama
      - chromadb
      - rag-service
    restart: unless-stopped

  upload-service:
    build:
      context: ./services/upload-service
      dockerfile: Dockerfile
    container_name: rma-upload-service
    ports:
      - "0.0.0.0:8103:8103"
    volumes:
      - upload_data:/data/uploads
    environment:
      - JWT_SECRET=${JWT_SECRET:-change-this-in-production}
      - UPLOAD_DIR=/data/uploads
      - DOC_PROCESSOR_URL=http://doc-processor:8101
      - CLIENT_RAG_URL=http://client-rag-service:8104
      - RAG_SERVICE_URL=http://rag-service:8102
      - APP_BASE_URL=${APP_BASE_URL:-http://localhost:3000}
    depends_on:
      - doc-processor
      - client-rag-service
      - rag-service
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rma-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_NOTES_SERVICE_URL=http://localhost:8100
      - NEXT_PUBLIC_DOC_PROCESSOR_URL=http://localhost:8101
      - NEXT_PUBLIC_RAG_SERVICE_URL=http://localhost:8102
      - NEXT_PUBLIC_UPLOAD_SERVICE_URL=http://localhost:8103
    depends_on:
      - notes-service
      - doc-processor
      - rag-service
      - upload-service
    restart: unless-stopped

  mcp-server:
    build:
      context: ./services/mcp-server
      dockerfile: Dockerfile
    container_name: rma-mcp-server
    ports:
      - "8105:8105"
    environment:
      - RAG_SERVICE_URL=http://rag-service:8102
      - CLIENT_RAG_URL=http://client-rag-service:8104
      - MCP_API_KEY=${MCP_API_KEY:-dev-key-change-in-production}
      - PORT=8105
    depends_on:
      - rag-service
      - client-rag-service
    restart: unless-stopped

  n8n:
    image: n8nio/n8n:latest
    container_name: rma-n8n
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./services/n8n/workflows:/workflows:ro
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-changeme123}
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Europe/London
    depends_on:
      - mcp-server
    restart: unless-stopped

volumes:
  ollama_data:
  chroma_data:  # Shared ChromaDB storage for all collections
  upload_data:
  n8n_data:

networks:
  default:
    name: rma-network
