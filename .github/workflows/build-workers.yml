name: Build and Push Worker Containers

on:
  push:
    branches:
      - master
    paths:
      - 'RMA-Demo/worker-containers/universal-worker/**'
      - 'RMA-Demo/services/local-coordinator/**'
      - 'RMA-Demo/edge-coordinator.yml'
      - '.github/workflows/build-workers.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build-universal-worker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/universal-worker
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=ref,event=branch

      - name: Build and push Universal Worker
        uses: docker/build-push-action@v5
        with:
          context: RMA-Demo/worker-containers/universal-worker
          file: RMA-Demo/worker-containers/universal-worker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Generate deployment instructions
        run: |
          echo "## ðŸš€ Universal Worker Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The universal worker supports **ALL 14 services** across **4 tiers**!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Auto-detection (Recommended):" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}/universal-worker:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Worker auto-detects hardware capabilities" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d \\" >> $GITHUB_STEP_SUMMARY
          echo "  --name rma-worker \\" >> $GITHUB_STEP_SUMMARY
          echo "  --restart unless-stopped \\" >> $GITHUB_STEP_SUMMARY
          echo "  --gpus all \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e COORDINATOR_URL=https://api.rmatool.org.uk \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e WORKER_TYPE=auto \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ github.repository }}/universal-worker:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GPU Worker (Tier 1):" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run -d --gpus all \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e WORKER_TYPE=gpu \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e COORDINATOR_URL=https://api.rmatool.org.uk \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ github.repository }}/universal-worker:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CPU Worker (Tier 2):" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run -d \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e WORKER_TYPE=cpu \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e COORDINATOR_URL=https://api.rmatool.org.uk \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ github.repository }}/universal-worker:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Storage Worker (Tier 3):" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run -d \\" >> $GITHUB_STEP_SUMMARY
          echo "  -v ./chroma-data:/chroma/chroma \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e WORKER_TYPE=storage \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e COORDINATOR_URL=https://api.rmatool.org.uk \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ github.repository }}/universal-worker:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Edge Worker (Tier 4):" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run -d \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 8080:8080 -p 8787:8787 -p 8090:8090 \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e WORKER_TYPE=edge \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e COORDINATOR_URL=https://api.rmatool.org.uk \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ github.repository }}/universal-worker:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  build-coordinator:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/coordinator
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=ref,event=branch

      - name: Build and push Coordinator
        uses: docker/build-push-action@v5
        with:
          context: RMA-Demo/services/local-coordinator
          file: RMA-Demo/services/local-coordinator/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Generate deployment instructions
        run: |
          echo "## ðŸŽ¯ Local Coordinator Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull and run the coordinator:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}/coordinator:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d \\" >> $GITHUB_STEP_SUMMARY
          echo "  --name rma-coordinator \\" >> $GITHUB_STEP_SUMMARY
          echo "  --restart unless-stopped \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 8080:8080 \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ github.repository }}/coordinator:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  notify-success:
    needs: [build-universal-worker, build-coordinator]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment summary
        run: |
          echo "## âœ… All Containers Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒŸ Universal Worker (NEW!)" >> $GITHUB_STEP_SUMMARY
          echo "\`ghcr.io/${{ github.repository }}/universal-worker:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Supports all 14 microservices across 4 tiers:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Tier 1 (GPU) - 3 services:" >> $GITHUB_STEP_SUMMARY
          echo "- llm-inference (vLLM, Llama 3.2)" >> $GITHUB_STEP_SUMMARY
          echo "- vision-ocr (LLaVA)" >> $GITHUB_STEP_SUMMARY
          echo "- rag-embeddings (sentence-transformers)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Tier 2 (CPU) - 3 services:" >> $GITHUB_STEP_SUMMARY
          echo "- ner-extraction (spaCy)" >> $GITHUB_STEP_SUMMARY
          echo "- document-processing (PyPDF2, docx)" >> $GITHUB_STEP_SUMMARY
          echo "- notes-coa (advisor notes)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Tier 3 (Storage) - 5 services:" >> $GITHUB_STEP_SUMMARY
          echo "- chromadb (vector DB)" >> $GITHUB_STEP_SUMMARY
          echo "- redis (cache)" >> $GITHUB_STEP_SUMMARY
          echo "- postgres (relational DB)" >> $GITHUB_STEP_SUMMARY
          echo "- minio (S3 storage)" >> $GITHUB_STEP_SUMMARY
          echo "- neo4j (graph DB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Tier 4 (Edge) - 3 services:" >> $GITHUB_STEP_SUMMARY
          echo "- coordinator (worker registry)" >> $GITHUB_STEP_SUMMARY
          echo "- edge-proxy (routing)" >> $GITHUB_STEP_SUMMARY
          echo "- load-balancer (traffic distribution)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Local Coordinator" >> $GITHUB_STEP_SUMMARY
          echo "\`ghcr.io/${{ github.repository }}/coordinator:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- In-memory worker registry (no KV limits!)" >> $GITHUB_STEP_SUMMARY
          echo "- Dynamic service assignment based on gaps" >> $GITHUB_STEP_SUMMARY
          echo "- Health tracking with 30s heartbeats" >> $GITHUB_STEP_SUMMARY
          echo "- Admin API for monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– **Documentation:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Zero-Cost Deployment Guide](https://github.com/${{ github.repository }}/blob/master/RMA-Demo/ZERO_COST_DEPLOYMENT.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Edge Federation Guide](https://github.com/${{ github.repository }}/blob/master/RMA-Demo/EDGE_FEDERATION_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Dynamic Service Allocation Guide](https://github.com/${{ github.repository }}/blob/master/RMA-Demo/DYNAMIC_SERVICE_ALLOCATION.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Tier 4 Architecture](https://github.com/${{ github.repository }}/blob/master/RMA-Demo/TIER_4_ARCHITECTURE.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Quick Start:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Deploy edge router: \`./deploy-edge-router.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Start coordinator: \`docker-compose -f edge-coordinator.yml up -d\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Start worker: \`docker run -e WORKER_TYPE=auto ghcr.io/${{ github.repository }}/universal-worker:latest\`" >> $GITHUB_STEP_SUMMARY
