version: '3.8'

services:
  ollama:
    image: ollama/ollama:latest
    container_name: rma-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  chromadb:
    image: chromadb/chroma:latest
    container_name: rma-chromadb
    ports:
      - "8005:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    restart: unless-stopped

  notes-service:
    build:
      context: ./services/notes-service
      dockerfile: Dockerfile
    container_name: rma-notes-service
    ports:
      - "8100:8100"
    environment:
      - OLLAMA_URL=http://ollama:11434
    depends_on:
      - ollama
    restart: unless-stopped

  doc-processor:
    build:
      context: ./services/doc-processor
      dockerfile: Dockerfile
    container_name: rma-doc-processor
    ports:
      - "8101:8101"
    environment:
      - LLAMA_PARSE_API_KEY=${LLAMA_PARSE_API_KEY:-}
    restart: unless-stopped

  rag-service:
    build:
      context: ./services/rag-service
      dockerfile: Dockerfile
    container_name: rma-rag-service
    ports:
      - "8102:8102"
    volumes:
      - rag_vectorstore:/data/vectorstore
      - ./manuals:/manuals
    environment:
      - OLLAMA_URL=http://ollama:11434
      - VECTORSTORE_PATH=/data/vectorstore
      - MANUALS_PATH=/manuals
    depends_on:
      - ollama
      - chromadb
    restart: unless-stopped

  upload-service:
    build:
      context: ./services/upload-service
      dockerfile: Dockerfile
    container_name: rma-upload-service
    ports:
      - "8103:8103"
    volumes:
      - upload_data:/data/uploads
    environment:
      - JWT_SECRET=${JWT_SECRET:-change-this-in-production}
      - UPLOAD_DIR=/data/uploads
      - DOC_PROCESSOR_URL=http://doc-processor:8101
      - APP_BASE_URL=${APP_BASE_URL:-http://localhost:3000}
    depends_on:
      - doc-processor
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rma-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_NOTES_SERVICE_URL=http://localhost:8100
      - NEXT_PUBLIC_DOC_PROCESSOR_URL=http://localhost:8101
      - NEXT_PUBLIC_RAG_SERVICE_URL=http://localhost:8102
      - NEXT_PUBLIC_UPLOAD_SERVICE_URL=http://localhost:8103
    depends_on:
      - notes-service
      - doc-processor
      - rag-service
      - upload-service
    restart: unless-stopped

volumes:
  ollama_data:
  chroma_data:
  rag_vectorstore:
  upload_data:

networks:
  default:
    name: rma-network
